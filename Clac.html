from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
import logging
import re

logger = logging.getLogger(__name__)

@csrf_exempt
def chat_handler(request):
    if request.method == 'POST':
        try:
            user_query = request.POST.get('query', '').strip().lower()
            logger.info(f"Received query: {user_query}")  # Debugging

            # Handle ranking prediction
            if any(keyword in user_query for keyword in ["efficacy", "pk/pd", "immunogenicity", "safety"]):
                # --- Your existing code to parse impacts/uncertainties ---
                impacts = []
                uncertainties = []
                try:
                    for attr in ["efficacy", "pk/pd", "immunogenicity", "safety"]:
                        impact_match = re.search(rf"{attr} impact=(\d+)", user_query)
                        uncertainty_match = re.search(rf"{attr} uncertainty=(\d+)", user_query)
                        
                        impact = float(impact_match.group(1)) if impact_match else 0.0
                        uncertainty = float(uncertainty_match.group(1)) if uncertainty_match else 0.0
                        
                        impacts.append(impact)
                        uncertainties.append(uncertainty)

                    if len(impacts) != 4 or len(uncertainties) != 4:
                        return JsonResponse({'response': "Error: Specify all 4 attributes (Efficacy, PK/PD, Immunogenicity, Safety)."})

                    result = agent.predict_ranking(impacts, uncertainties)
                    return JsonResponse({
                        'response': f"Overall Ranking: {result['overall_ranking']}\n"
                                    f"Criticality Scores: {result['criticality_scores']}\n"
                                    f"Row Rankings: {result['row_rankings']}"
                    })

                except Exception as e:
                    logger.error(f"Error in ranking prediction: {str(e)}")
                    return JsonResponse({'response': f"Error: {str(e)}"})

            # Handle general Q&A (justifications, citations)
            else:
                context = agent.retrieve_context(user_query)
                prompt = f"""
                You are a Criticality Risk Ranking assistant. Use this context:
                {context}

                Question: {user_query}
                Answer (cite sources as [Citation X]):
                """
                answer = agent.ask_ollama(prompt)
                return JsonResponse({'response': answer})

        except Exception as e:
            logger.error(f"Unexpected error: {str(e)}")
            return JsonResponse({'response': "An error occurred. Please try again."})

    # Return error for non-POST requests
    return JsonResponse({'error': 'POST requests only'}, status=400)
